<!doctype html>
<html lang="en">
   <head>
      <!-- Required meta tags -->
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
      <title>[SEMI1]Practica2-Grupo 37</title>
      <!-- Favicon -->
      <link rel="shortcut icon" href="images/favicon.ico" />
      <!-- Bootstrap CSS -->
      <link rel="stylesheet" href="css/bootstrap.min.css">
      <!-- Typography CSS -->
      <link rel="stylesheet" href="css/typography.css">
      <!-- Style CSS -->
      <link rel="stylesheet" href="css/style.css">
      <!-- Responsive CSS -->
      <link rel="stylesheet" href="css/responsive.css">
   </head>
   <body>
      <!-- loader Start -->
      <div id="loading">
         <div id="loading-center">
         </div>
      </div>
      <!-- loader END -->
        <!-- Sign in Start -->
        <section class="sign-in-page">
          <div id="container-inside">
              <div id="circle-small"></div>
              <div id="circle-medium"></div>
              <div id="circle-large"></div>
              <div id="circle-xlarge"></div>
              <div id="circle-xxlarge"></div>
          </div>
            <div class="container p-0">
                <div class="row no-gutters">
                    <div class="col-md-6 text-center pt-5">
                        <div class="sign-in-detail text-white">
                            <a class="sign-in-logo mb-5" href="#"><h1>UGRAM</h1></a>
                            <div class="owl-carousel" data-autoplay="true" data-loop="true" data-nav="false" data-dots="true" data-items="1" data-items-laptop="1" data-items-tab="1" data-items-mobile="1" data-items-mobile-sm="1" data-margin="0">
                                <div class="item">
                                    <img src="images/login/1.png" class="img-fluid mb-4" alt="logo">
                                    <h4 class="mb-1 text-white">Administra tu perfil de forma facil</h4>
                                    <p></p>
                                </div>
                                <div class="item">
                                    <img src="images/login/2.png" class="img-fluid mb-4" alt="logo"> 
                                    <h4 class="mb-1 text-white">Visualiza tus albumes</h4>
                                    <!-- <p>It is a long established fact that a reader will be distracted by the readable content.</p> -->
                                </div>
                                <div class="item">
                                    <img src="images/login/3.png" class="img-fluid mb-4" alt="logo">
                                    <h4 class="mb-1 text-white">Sube tus fotos favoritas</h4>
                                    <!-- <p>It is a long established fact that a reader will be distracted by the readable content.</p> -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 bg-white pt-5">
                        <div class="sign-in-from">
                            <h1 class="mb-0">Registrarse</h1>
                            <p>Ingresa un nombre de usuario y contraseña para crear tu cuenta.</p>
                            <form class="mt-4">
                                <div class="form-group">
                                    <label for="validationDefault01">Nombre</label>
                                    <input type="text" class="form-control mb-0" id="nombre_id" placeholder="Ingresa tu nombre">
                                </div>
                                <div class="form-group">
                                    <label for="validationDefault01">Apellido</label>
                                    <input type="text" class="form-control mb-0" id="apellido_id" placeholder="Ingresa tu apellido">
                                </div>
                                <div class="form-group">
                                    <label for="validationDefaultUsername">Nickname</label>
                                    <!-- <input type="text" class="form-control mb-0" id="exampleInputPassword1" placeholder="Ingresa un nickname"> -->
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                           <span class="input-group-text" id="inputGroupPrepend2">@</span>
                                        </div>
                                        <input type="text" class="form-control" id="username_id"  aria-describedby="inputGroupPrepend2" placeholder="Ingresa un nickname" required>
                                     </div>
                                </div>
                                <div class="form-group">
                                    <label for="exampleInputPassword1">Contraseña</label>
                                    <input type="password" class="form-control mb-0" id="contrasenia_id" placeholder="Crea una contraseña (6 caracteres minimo)">
                                </div>
                                <div class="form-group">
                                    <label for="exampleInputPassword1">Foto de perfil</label>
                                    <!-- <input type="file" class="form-control mb-0" id="exampleInputPassword1" placeholder="Foto"> -->
                                    <div class="custom-file">
                                        <input type="file" class="custom-file-input" id="foto_id" required>
                                        <label class="custom-file-label" for="validatedCustomFile">Elegir foto...</label>
                                        <div class="invalid-feedback">Example invalid custom file feedback</div>
                                     </div>
                                </div>
                                <div class="d-inline-block w-100">
                                    <div class="custom-control custom-checkbox d-inline-block mt-2 pt-1">
                                        <input type="checkbox" class="custom-control-input" id="customCheck1">
                                        <label class="custom-control-label" for="customCheck1">Acepto los<a href="#"> terminos y condiciones</a></label>
                                    </div>
                                    <button type="button" class="btn btn-primary float-right" onclick="registro(this.form)">Registrarme</button>
                                </div>
                                <div class="sign-info">
                                    <span class="dark-color d-inline-block line-height-2">¿Ya tienes una cuenta? <a href="/index.html">Iniciar sesión</a></span>
                                    <ul class="iq-social-media">
                                        <li><a href="#"><i class="ri-facebook-box-line"></i></a></li>
                                        <li><a href="#"><i class="ri-twitter-line"></i></a></li>
                                        <li><a href="#"><i class="ri-instagram-line"></i></a></li>
                                    </ul>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- Sign in END -->
      <!-- Optional JavaScript -->
      <!-- jQuery first, then Popper.js, then Bootstrap JS -->
      <script src="js/jquery.min.js"></script>
      <script src="js/popper.min.js"></script>
      <script src="js/bootstrap.min.js"></script>
      <!-- Appear JavaScript -->
      <script src="js/jquery.appear.js"></script>
      <!-- Countdown JavaScript -->
      <script src="js/countdown.min.js"></script>
      <!-- Counterup JavaScript -->
      <script src="js/waypoints.min.js"></script>
      <script src="js/jquery.counterup.min.js"></script>
      <!-- Wow JavaScript -->
      <script src="js/wow.min.js"></script>
      <!-- lottie JavaScript -->
      <script src="js/lottie.js"></script>
      <!-- Apexcharts JavaScript -->
      <script src="js/apexcharts.js"></script>
      <!-- Slick JavaScript -->
      <script src="js/slick.min.js"></script>
      <!-- Select2 JavaScript -->
      <script src="js/select2.min.js"></script>
      <!-- Owl Carousel JavaScript -->
      <script src="js/owl.carousel.min.js"></script>
      <!-- Magnific Popup JavaScript -->
      <script src="js/jquery.magnific-popup.min.js"></script>
      <!-- Smooth Scrollbar JavaScript -->
      <script src="js/smooth-scrollbar.js"></script>
      <!-- Chart Custom JavaScript -->
      <script src="js/chart-custom.js"></script>
      <!-- Custom JavaScript -->
      <script src="js/custom.js"></script>
      <!-- ***************  Script para registro ********************** -->
      <script language="javascript" src="js/practica1/encode64.js"></script>
      <script language="javascript">
       async function registro(form) {
            // Obteniendo valores para data
            var foto_nombre_ext = form.foto_id.files[0].name.split('.');
            var fotoblob = form.foto_id.files[0];
            var dateNow = Date.now();
            // Data values
            var id_user = dateNow + form.nombre_id.value;
            var contrasenia = form.contrasenia_id.value;
            var nombre = form.nombre_id.value;
            var apellido = form.apellido_id.value;
            var username = form.username_id.value;
            var foto_nombre = foto_nombre_ext[0];
            var foto_ext = form.foto_id.files[0].name.split('.').pop().toLowerCase();
            var foto_b64 = "";            
            // ---  Convertir foto a b64    ---
            const callback = result =>{
                    // console.log('res: ', result);
                }

            // console.log("callback: ", callback.result);
            var promise = codificar64(fotoblob, callback);
            promise.then(async function (result){
                foto_b64 = result;
                // ++++++ POST ++++++++++
                try{
                    let data = {
                        nombre: nombre,
                        contrasenia: contrasenia,
                        apellido: apellido,
                        username: username,
                        foto_b64: foto_b64,
                        foto_nombre: foto_nombre,
                        foto_ext: foto_ext,
                        id_user: id_user
                    };
                    // ///////////// ///////////// ///////////
                    // /////////// Comprobando usuario /////////////
                    // data to be sent to the POST request
                    let _data = {
                        user: username,
                        pass: contrasenia
                    };
                    let data_response = "";
                    const req = await fetch('http://localhost:3333/verificar', {
                        method: "POST",
                        body: JSON.stringify(_data),
                        headers: {"Content-type": "application/json; charset=UTF-8"}
                    });
                    // .then(response => response.json())
                    // .catch(err => console.log(err));

                    const res = await req.json();
                    data_response = res;
                    console.log("data_response: ", data_response.message);
                    // console.log("data_response_user: ", data_response.User.username.S);
                    if(data_response.message == 1){
                        data_user = data_response.User;
                        var user = data_user.username.S;
                        if (username == user) { 
                                alert("¡Este usuario ya existe!")
                        } 
                    }else {  
                            console.log("Registrando usuario");
                            // ///////////// ///////////// ///////////
                            // /////////// Registrando usuario /////////////
                            // ///////////// ///////////// ///////////
                            console.log("data: ", JSON.stringify(data));

                            let data_response_reg = "";
                            const req = await fetch('http://localhost:3333/registro', {
                                method: "POST",
                                body: JSON.stringify(data),
                                headers: {"Content-type": "application/json; charset=UTF-8"}
                            })
                            // .then(response => response.json())
                            // .catch(err => console.log(err));
                            // ///////////// ///////////// ///////////
                            // /////////// Comprobando usuario /////////////
                            // data to be sent to the POST request
                            let _data_ = {
                                user: username,
                                pass: contrasenia
                            };
                            let data_response_ver = "";
                            const req_ver = await fetch('http://localhost:3333/verificar', {
                                method: "POST",
                                body: JSON.stringify(_data_),
                                headers: {"Content-type": "application/json; charset=UTF-8"}
                            });
                            // .then(response => response.json())
                            // .catch(err => console.log(err));

                            const res_ver = await req_ver.json();
                            data_response_ver = res_ver;
                            console.log("usuario_activo: ", data_response_ver.User);
                            data_user_ver = data_response_ver.User;
                            localStorage.setItem("usuario_activo", JSON.stringify(data_user_ver));
                            // alert("Se registro exitosamente, ahora puedes iniciar sesion.");
                            location="index.html";
                            // ///////////// ///////////// ///////////
                            // ///////////// ///////////// ///////////
                        }
                    // ///////////// ///////////// ///////////
                    // ///////////// ///////////// ///////////
                } catch(err){
                    console.log("error: ", err);
                }
                // ++++++ POST ++++++++++
            }); 
        }

        function codificar64(fotoblob, callback){
                return new Promise (function (resolve, reject) {
                    var reader = new FileReader();
                    reader.onloadend = function(){
                        callback(reader.result);
                        resolve(reader.result);
                        // console.log('RESULT', reader.result);
                    }
                    reader.onerror = reject;
                    reader.readAsDataURL(fotoblob);
                });
        }
     </script>
   </body>
</html>